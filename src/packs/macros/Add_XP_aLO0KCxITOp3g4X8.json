{
  "_id": "aLO0KCxITOp3g4X8",
  "author": "MJAZjdKh3QKREKG2",
  "command": "/* ==========\n* MACRO: Add XP\n* AUTHOR: Robak132\n* DESCRIPTION: Adds a set amount of XP to all or targeted player character(s). Adds half XP to companion(s). Modified macro from GM Toolkit by Jagusti.\n========== */\n\naddXP();\n\nfunction getCurrentDate() {\n  const currentDate = new Date();\n  const year = currentDate.getFullYear();\n  const month = (\"0\" + (currentDate.getMonth() + 1)).slice(-2);\n  const day = (\"0\" + currentDate.getDate()).slice(-2);\n  return year + \"-\" + month + \"-\" + day;\n}\n\nasync function addXP() {\n  let awardees = [];\n  let halfAwardees = [];\n  if (game.user.targets.size < 1) {\n    awardees = game.users.filter((u) => u.character).map((g) => g.character);\n    halfAwardees = game.actors.filter((a) => a.hasPlayerOwner && a.type === \"character\" && !awardees.includes(a));\n  } else {\n    const group = game.actors.filter((a) => a.hasPlayerOwner && a.type === \"character\");\n    const targeted = game.canvas.tokens.placeables.filter((t) => t.isTargeted).map((t) => t.actor);\n    awardees = group.filter((a) => targeted.includes(a));\n  }\n  if (awardees.length < 1) {\n    return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Token.TargetPCs\"), {});\n  }\n\n  const XP = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultAmount\"));\n  let reason =\n    game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\") === \"null\"\n      ? \"\"\n      : game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\");\n  if (reason) {\n    reason = game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\");\n    const session = game.gmtoolkit.utility.getSession();\n    reason = reason.replace(\"(%date%)\", `(${getCurrentDate()})`);\n    reason = session.id !== \"null\" ? reason.replace(\"%session%\", session.id) : reason.replace(\"%session%\", \"\");\n  }\n\n  if (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPPrompt\")) {\n    let awardeeList = \"<p>Full Experience will be awarded to:</p><ul>\";\n    awardeeList += awardees.map((pc) => `<li>${pc?.actor?.name || pc.name}</li>`).join(\"\");\n    awardeeList += \"</ul>\";\n    let halfAwardeeList = \"<p>Half Experience will be awarded to:</p><ul>\";\n    halfAwardeeList += halfAwardees.map((pc) => `<li>${pc?.actor?.name || pc.name}</li>`).join(\"\");\n    halfAwardeeList += \"</ul>\";\n    await new Dialog({\n      title: game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Title\"),\n      content: `<form>\n              ${awardeeList}\n              ${halfAwardees.length > 0 ? halfAwardeeList : \"\"}\n              <div class=\"form-group\">\n                <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Prompt\")}</label> \n                <input type=\"text\" id=\"add-xp\" name=\"add-xp\" value=\"${XP}\" />\n              </div>\n              <div class=\"form-group\">\n                <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Reason\")}</label> \n                <input type=\"text\" id=\"xp-reason\" name=\"xp-reason\" value=\"${reason}\" />\n              </div>\n          </form>`,\n      buttons: {\n        yes: {\n          icon: \"<i class='fas fa-check'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n          callback: (html) => {\n            const XP = Math.round(html.find(\"#add-xp\").val());\n            if (isNaN(XP)) {\n              return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.InvalidXP\"));\n            }\n            const reason = html.find(\"#xp-reason\").val();\n            updateXP(awardees, halfAwardees, XP, reason);\n          }\n        },\n        no: {\n          icon: \"<i class='fas fa-times'></i>\",\n          label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\")\n        }\n      },\n      default: \"yes\"\n    }).render(true);\n  } else {\n    updateXP(awardees, halfAwardees, XP, reason);\n  }\n}\n\nfunction updateActorXP(pc, XP, reason) {\n  const recipient = pc?.actor?.name || pc.name;\n  const XPTotal = pc?.details?.experience?.total;\n  const newXPTotal = Math.max(XPTotal + XP, 0);\n  const XPCurrent = pc?.details?.experience?.current || 0;\n  const newXPCurrent = Math.max(XPCurrent + XP, 0);\n\n  pc?.actor ? pc.actor.awardExp(XP, reason) : pc.awardExp(XP, reason);\n\n  return game.i18n.format(\"GMTOOLKIT.AddXP.Success\", {\n    recipient,\n    XPTotal,\n    newXPTotal,\n    XPCurrent,\n    newXPCurrent\n  });\n}\n\nfunction updateXP(awardees, halfAwardees = [], XP, reason) {\n  const halfXP = Math.round(XP / 2);\n  let chatContent = \"\";\n\n  awardees.forEach((pc) => {\n    chatContent += updateActorXP(pc, XP, reason);\n  });\n  halfAwardees.forEach((pc) => {\n    chatContent += updateActorXP(pc, halfXP, reason);\n  });\n  const chatData = game.wfrp4e.utility.chatDataSetup(chatContent, \"gmroll\", false);\n  chatData.flavor = game.i18n.format(\"GMTOOLKIT.AddXP.Flavor\", {\n    XP,\n    reason\n  });\n  ChatMessage.create(chatData, {});\n}\n",
  "flags": {
    "wfrp4e-macros-and-more": {
      "version": "1.1.0"
    }
  },
  "folder": null,
  "img": "modules/wfrp4e-macros-and-more/assets/icons/add-xp-with-companions.svg",
  "name": "Add XP",
  "scope": "global",
  "type": "script",
  "_key": "!macros!aLO0KCxITOp3g4X8"
}
